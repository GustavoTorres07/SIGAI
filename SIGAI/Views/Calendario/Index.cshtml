@using SIGAI.Models.Entidades
@{
    ViewData["Title"] = "Calendario Universitario";
    var puedeCrear = ViewBag.PuedeCrear ?? false;
    var puedeEditar = ViewBag.PuedeEditar ?? false;
    var puedeEliminar = ViewBag.PuedeEliminar ?? false;
    var userRole = ViewBag.UserRole ?? "Estudiante";
    var categorias = ViewBag.Categorias as List<CategoriaCalendarioEvento> ?? new List<CategoriaCalendarioEvento>();
}

@section Styles {
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <link rel="stylesheet" href="~/css/calendario.css" />
    <style>
        .diagnostic-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
        }

            .diagnostic-panel h4 {
                color: #495057;
                margin-bottom: 10px;
            }

            .diagnostic-panel pre {
                background: #ffffff;
                padding: 10px;
                border-radius: 4px;
                font-size: 12px;
                max-height: 200px;
                overflow-y: auto;
            }

        .hide-diagnostic {
            display: none;
        }
    </style>
}

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.10/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Pasar permisos al JavaScript
        window.calendarioPermisos = {
            puedeCrear: @Json.Serialize(puedeCrear),
            puedeEditar: @Json.Serialize(puedeEditar),
            puedeEliminar: @Json.Serialize(puedeEliminar),
            userRole: '@userRole'
        };

        // Datos de diagnóstico
        window.diagnosticData = {
            usuario: '@User.Identity.Name',
            rol: '@userRole',
            permisos: {
                crear: @Json.Serialize(puedeCrear),
                editar: @Json.Serialize(puedeEditar),
                eliminar: @Json.Serialize(puedeEliminar)
            },
            categorias: @Json.Serialize(categorias)
        };

        console.log('Datos de diagnóstico:', window.diagnosticData);
    </script>
    <script src="~/js/calendario.js"></script>
}

<div class="dashboard-container">
    <!-- Panel de Diagnóstico -->
    <div class="diagnostic-panel" id="diagnosticPanel">
        <h4>🔍 Panel de Diagnóstico</h4>
        <div style="margin-bottom: 10px;">
            <button type="button" class="btn btn-sm btn-secondary" onclick="toggleDiagnostic()">
                <i class="bi bi-eye"></i> Mostrar/Ocultar Diagnóstico
            </button>
        </div>
        <div id="diagnosticContent" class="hide-diagnostic">
            <div><strong>Usuario:</strong> @User.Identity.Name</div>
            <div><strong>Rol:</strong> @userRole</div>
            <div><strong>Puede Crear:</strong> @(puedeCrear ? "✅ Sí" : "❌ No")</div>
            <div><strong>Puede Editar:</strong> @(puedeEditar ? "✅ Sí" : "❌ No")</div>
            <div><strong>Puede Eliminar:</strong> @(puedeEliminar ? "✅ Sí" : "❌ No")</div>
            <div><strong>Categorías Disponibles:</strong> @categorias.Count</div>
            @if (categorias.Count > 0)
            {
                <div><strong>Lista de Categorías:</strong></div>
                <pre>@foreach (var cat in categorias)
            {
                    <div>- @cat.Nombre (ID: @cat.Id, Color: @cat.ColorHex)</div>
            }
            </pre>
            }
            else
            {
                <div style="color: red;"><strong>⚠️ NO HAY CATEGORÍAS DISPONIBLES</strong></div>
            }
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <h1>📅 Dashboard - Calendario Universitario</h1>
        <div class="user-info">
            <div class="user-details">
                <div class="user-avatar">👤</div>
                <div class="user-text">
                    <div class="user-name" id="userName">@User.Identity.Name</div>
                    <div class="user-role" id="userRole">@userRole</div>
                </div>
            </div>
            <div class="permissions-badge" id="permissionsBadge">
                <span>🔐</span>
                <span id="permissionText">
                    @if (puedeCrear && puedeEditar && puedeEliminar)
                    {
                        <text>Permisos completos</text>
                    }
                    else if (puedeCrear || puedeEditar)
                    {
                        <text>Permisos limitados</text>
                    }
                    else
                    {
                        <text>Solo lectura</text>
                    }
                </span>
            </div>
        </div>
    </div>

    <!-- Información de Permisos -->
    <div class="permission-info">
        <h4>Permisos del Usuario</h4>
        <ul class="permission-list">
            <li>@(puedeCrear ? "✅" : "❌") Crear eventos</li>
            <li>@(puedeEditar ? "✅" : "❌") Editar eventos</li>
            <li>@(puedeEliminar ? "✅" : "❌") Eliminar eventos</li>
        </ul>
    </div>

    <!-- Formulario de Evento (solo visible si tiene permiso) -->
    @if (puedeCrear)
    {
        <div class="event-form" id="eventForm">
            <h3 class="form-title"><i class="bi bi-calendar-event"></i> Crear Nuevo Evento</h3>
            <form id="createEventForm">
                @Html.AntiForgeryToken()
                <div class="form-grid">
                    <div class="form-group">
                        <label for="eventTitle">Título del Evento *</label>
                        <input type="text" id="eventTitle" name="eventTitle" required placeholder="Ej: Examen Final - Matemáticas">
                    </div>
                    <div class="form-group">
                        <label for="eventCategory">Categoría *</label>
                        <select id="eventCategory" name="eventCategory" required>
                            <option value="">Seleccionar categoría</option>
                            @foreach (var categoria in categorias)
                            {
                                <option value="@categoria.Id" data-color="@categoria.ColorHex">@categoria.Nombre</option>
                            }
                        </select>
                        @if (categorias.Count == 0)
                        {
                            <div style="color: red; font-size: 12px; margin-top: 5px;">
                                ⚠️ No hay categorías disponibles. Contacta al administrador.
                            </div>
                        }
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="eventStart">Fecha y Hora de Inicio *</label>
                        <input type="datetime-local" id="eventStart" name="eventStart" required>
                    </div>
                    <div class="form-group">
                        <label for="eventEnd">Fecha y Hora de Fin *</label>
                        <input type="datetime-local" id="eventEnd" name="eventEnd" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="eventDescription">Descripción</label>
                    <textarea id="eventDescription" name="eventDescription" placeholder="Descripción detallada del evento..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" @(categorias.Count == 0 ? "disabled" : "")>
                        <i class="bi bi-save"></i> Crear Evento
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="clearForm()">
                        <i class="bi bi-trash"></i> Limpiar
                    </button>
                </div>
            </form>
        </div>
    }
    else
    {
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i>
            <strong>Sin permisos para crear eventos</strong><br>
            Tu rol actual (@userRole) no tiene permisos para crear eventos.
        </div>
    }

    <!-- Calendario -->
    <div class="calendar-wrapper">
        <div class="calendar-header">
            <h2 class="calendar-title">Calendario de Eventos</h2>
            <div id="calendarControls"></div>
        </div>
        <div id="calendar"></div>
    </div>

    <!-- Lista de Eventos -->
    <div class="events-list">
        <div class="events-list-header">
            <h3 class="events-list-title">Lista de Eventos</h3>
        </div>
        <div class="events-list-content">
            <div id="eventsList">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Cargando eventos...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Edición -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Editar Evento</h3>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <div id="editFormContainer">
                <form id="editEventForm">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="editEventId">
                    <input type="hidden" id="editEventCreadoPor">
                    <div class="form-group">
                        <label for="editEventTitle">Título del Evento *</label>
                        <input type="text" id="editEventTitle" name="editEventTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="editEventCategory">Categoría *</label>
                        <select id="editEventCategory" name="editEventCategory" required>
                            @foreach (var categoria in categorias)
                            {
                                <option value="@categoria.Id" data-color="@categoria.ColorHex">@categoria.Nombre</option>
                            }
                        </select>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="editEventStart">Fecha y Hora de Inicio *</label>
                            <input type="datetime-local" id="editEventStart" name="editEventStart" required>
                        </div>
                        <div class="form-group">
                            <label for="editEventEnd">Fecha y Hora de Fin *</label>
                            <input type="datetime-local" id="editEventEnd" name="editEventEnd" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editEventDescription">Descripción</label>
                        <textarea id="editEventDescription" name="editEventDescription"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" id="btnActualizar">
                            <i class="bi bi-save"></i> Actualizar
                        </button>
                        <button type="button" class="btn btn-danger" id="btnEliminar" onclick="deleteEvent()">
                            <i class="bi bi-trash"></i> Eliminar
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </button>
                    </div>
                </form>
            </div>
            <div id="accessDeniedContainer" class="access-denied" style="display: none;">
                <div class="access-denied-icon">🔒</div>
                <h3>Acceso Denegado</h3>
                <p>No tienes permisos para editar este evento.</p>
                <p>Solo los usuarios con permisos de edición pueden modificar eventos.</p>
            </div>
        </div>
    </div>
</div>

<script>
    function toggleDiagnostic() {
        const content = document.getElementById('diagnosticContent');
        content.classList.toggle('hide-diagnostic');
    }
</script>